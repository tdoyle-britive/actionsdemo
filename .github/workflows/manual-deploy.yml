# .github/workflows/manual-deploy.yml
name: Deploy to Britive Intranet Staging

on:
  workflow_dispatch:
    inputs:
      justification:
        description: 'Reason for the deployment (audit)'
        required: true
        type: string

permissions:
  contents: read
  id-token: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install pybritive
        run: pip install pybritive

      - name: Configure Britive & AWS credentials
        env:
          BRITIVE_TENANT: ${{ secrets.BRITIVE_TENANT }}
          BRITIVE_PROFILE_ALIAS: ${{ secrets.BRITIVE_PROFILE_ALIAS }}
          BRITIVE_FULL_PROFILE: ${{ secrets.BRITIVE_FULL_PROFILE }}
        run: |
          pybritive configure tenant --tenant "$BRITIVE_TENANT" --no-prompt
          pybritive configure global --tenant "$BRITIVE_TENANT" --format json --no-prompt
          pybritive configure update profile-aliases "$BRITIVE_PROFILE_ALIAS" "$BRITIVE_FULL_PROFILE"
      
          mkdir -p ~/.aws
          cat << EOF > ~/.aws/credentials
          [$BRITIVE_PROFILE_ALIAS]
          credential_process = pybritive checkout $BRITIVE_PROFILE_ALIAS -m awscredentialprocess -P Github --justification "${{ inputs.justification }}"
          EOF
      
          aws sts get-caller-identity --profile "$BRITIVE_PROFILE_ALIAS"
        shell: bash

      - name: Sync site to S3
        env:
          S3_BUCKET: ${{ secrets.S3_STAGING_BUCKET }}
          BRITIVE_PROFILE_ALIAS: ${{ secrets.BRITIVE_PROFILE_ALIAS }}
        run: |
          echo "Deploying to $S3_BUCKET ..."
          aws s3 sync . "$S3_BUCKET" \
            --profile "$BRITIVE_PROFILE_ALIAS" \
            --exclude ".git/*" \
            --exclude ".github/*" \
            --exclude "node_modules/*" \
            --delete
        shell: bash

      - name: Check-in Britive profile
        if: always()
        env:
          BRITIVE_PROFILE_ALIAS: ${{ secrets.BRITIVE_PROFILE_ALIAS }}
        run: |
          pybritive checkin "$BRITIVE_PROFILE_ALIAS" -P Github || true
        shell: bash
